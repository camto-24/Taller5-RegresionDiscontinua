---
title: "Taller 5 - Regresión Discontinua"
author: "Maria Camila Caraballo, Laura Sarif Rivera Sanabria"
output:
  pdf_document:
    latex_engine: xelatex
  word_document: default
geometry: top=1.5cm, bottom=1.5cm, left=2cm, right=2cm
output_dir: outputs
header-includes: \usepackage{adjustbox}
---

```{r setup, include= FALSE, echo=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
knitr::opts_knit$set(root.dir = "C:/1. MECA/2025/EVALUACIACÓN DE IMPACTO- Raachid Raaj/Taller5-RegresionDiscontinua")

tinytex::tlmgr_update(self = TRUE, all = TRUE)

if (!requireNamespace("tinytex", quietly = TRUE)) {
  install.packages("tinytex")
}

# Verificar si TinyTeX está instalado
if (tinytex::is_tinytex()) {
  message("TinyTeX detectado. Actualizando instalación...")

  # Actualizar gestor de paquetes (self) y todos los paquetes
  tinytex::tlmgr_update(self = TRUE, all = TRUE)

  message("✅ TinyTeX actualizado correctamente.")
} else {
  message("No se detecta TinyTeX. Si usas MikTeX o TeX Live, actualiza manualmente.")
}
```

```{r results='asis', echo=FALSE}
# Cargar liberias y paquetes

# Instalando pacman si se requiere
if (!require("pacman")) install.packages("pacman")

# Cargando los paquetes usando pacman
pacman::p_load(
  
  # A) Manipulación, limpieza y visualización de datos
  tidyverse,    # Colección de paquetes esenciales (incluye dplyr, ggplot2, etc.)
  dplyr,        # Manipulación de datos (ya incluido en tidyverse, pero lo dejamos explícito).
  ggplot2,      # Visualización de datos (incluido en tidyverse).
  scales,       # Manejo de escalas (ej. porcentajes, comas).
  skimr,        # Resúmenes estadísticos rápidos de data.frames.
  
  # B) Modelado y análisis estadístico/econométrico
  fixest,       # Modelos de efectos fijos de alto rendimiento.
  plm,          # Modelos para datos de panel.
  AER,          # Herramientas de econometría aplicada.
  lmtest,       # Pruebas de hipótesis para modelos de regresión.
  sandwich,     # Errores estándar robustos.
  survey,       # Análisis de encuestas complejas.
  
  # C) Importación, exportación y generación de reportes
  haven,        # Lectura/escritura de Stata, SAS, SPSS.
  stargazer,    # Tablas de regresión con formato publicable.
  knitr,        # Reportes dinámicos en RMarkdown.
  modelsummary, # Tablas y resúmenes comparativos de modelos.
  tinytex       # Soporte para compilar a PDF con LaTeX en RMarkdown.
)

library(lfe)
```

## Regresión Discontinua

En su artículo “Islamic Rule and the Empowerment of the Poor and Pious”, Meyersson (2014) investiga si la llegada al poder por parte del Partido Islámico tiene algún efecto sobre el empoderamiento de las mujeres en Turquía. Para esto, implementa la metodología de Regresión Discontinua, explotando información de: (1) elecciones locales de alcalde en Turquía del año 1994 y (2) mujeres con educación secundaria completa en el año 2000. Concretamente, estima por MCO la siguiente ecuación

$$y_i=α+βm_i+f(x_i )+ε_i$$

donde y_i es la proporción de mujeres entre 15 y 20 años con educación secundaria completa en el año 2000, x_i es el margen de votos con el que ganó o perdió el candidato del partido islámico, f(⋅) es un polinomio de grado n de la variable x_i, m_i es una dicótoma que toma el valor de uno si x_i≥0, es decir, si el alcalde que llegó al poder en 1994 era del partido Islámico y ε_i es el término del error. La ecuación es estimada en un vecindario alrededor del corte, el cual, en este caso, es cero.

## 0. Paso inicial

Para esto se deberá eliminar aleatoriamente el 5% de las observaciones y usar la base restante. La semilla que deben usar para que sus resultados sean replicables es su código de estudiante.

```{r}
# Definir carpeta de datos (ruta relativa) 
path <- file.path(getwd(), "Datos/turquia.dta")
data <- read_dta(path)

# Fijar semilla con el cod de Laura
set.seed(202421904)

# Eliminar aletoriamente el 5% de las obs
n_eliminar <- round(0.05 * nrow(data))
filas_eliminar <- sample(1:nrow(data), n_eliminar)
turquia <- data[-filas_eliminar, ]
```

```{r}
# Tratamiento de si se eligio un alcalde islamico
turquia <- turquia %>%
  rename(xi = ilmvsm1994) %>%       # renombrar la running variable
  mutate(
    di = ifelse(xi >= 0, 1, 0),    # tratamiento: alcalde islámico
    hischshr1520m = hischshr1520m / 100,  # pasar a proporción
    hischshr1520f = hischshr1520f / 100
  )

```

## 1) ¿Por qué el autor usa la metodología de Regresión Discontinua para identificar los efectos de interés? ¿Cuál es la intuición detrás? ¿Cuál es el supuesto de identificación?

Erik Meyersson (2014) en su paper Islamic Rule And The Empowerment of the Poor and Pious busca identificar un efecto causal de las elecciones de particuos islámicos de los municipios en Turquia sobre los resultados de empoderamiento de las mujeres medido como la proporción de jóvenes entre 15 y 20 años con educación secundaria completa. Para ello utiliza la metodología de Regresión Discontinua (RD) aprovechando que la asignación del tratamiento, es decir, si es un alcalde islámico no es aleatoria, dado que los municipios que eligen a este tipo de líderes pueden diferir en factores culturales, religiosos o socioeconómicos, una simple comparación entre municipios con y sin alcalde islámico generaría estimaciones sesgadas.La estrategia de RD permite aproximarse a un experimento natural. La intuición es que los municipios donde el candidato islámico ganó o perdió por un margen pequeño puede ser comparable en todas sus características observables y no observables, de modo que el hecho de haber obtenido la alcaldía o no puede considerarse casi aleatorio. 

El supuesto de identificación implica que, en ausencia del tratamiento, es decir, de haber tenido un alcalde del partido islámico, los resultados potenciales, como la proporción de mujeres jóvenes con educación secundaria completa serían continuos en torno al punto de corte del margen electoral. Esto implica que los municipios donde el candidato islámico ganó o perdió por muy poco son, en promedio, comparables en todas las características relevantes que podrían afectar el empoderamiento femenino.

## 2) Para cada género, presenten en una tabla los resultados de estimar las siguientes especificaciones

a.  Ecuación principal, para toda la muestra, sin incluir controles.

```{r}
# Primer modelo sin controles para ambos sexos
modelo_f <- lm(hischshr1520f ~ di + xi, data = turquia)  # mujeres
modelo_m <- lm(hischshr1520m ~ di + xi, data = turquia)  # hombres

# Errores estándar agrupados por provincia
se_f <- sqrt(diag(vcovCL(modelo_f, cluster = ~ prov_num)))
se_m <- sqrt(diag(vcovCL(modelo_m, cluster = ~ prov_num)))

# Tabla en Latex para Pdf
tabla1 <- capture.output(
  stargazer(
    modelo_f, modelo_m,
    type = "latex",
    se = list(se_f, se_m),
    title = "Regresión Discontinua: efecto de alcaldes islámicos sobre educación secundaria",
    column.labels = c("Mujeres", "Hombres"),
    dep.var.labels = "Proporción con secundaria completa (15–20 años)",
    covariate.labels = c("Alcalde islámico (Dᵢ)", "Running Variable(Xᵢ)"),
    notes = "Errores estándar agrupados por provincia.",
    digits = 3,
    label = "tab:rd_mujeres_hombres",
    header = FALSE,  
    table.placement = "ht!"
  )
)

# Quitar comentarios de stargazer (para un .tex limpio)
tabla1 <- tabla1[!grepl("^%", tabla1)]

# --- Guardar .tex limpio ---
writeLines(tabla1, "Tablas/tabla1.tex")

# Mostrar tabla en consola (opcional)
cat(tabla1, sep = "\n")
```

b.  Ecuación principal, para toda la muestra, con controles.

```{r}
# Con controles y polinomio lineal 
# Mujeres
modelo_f2 <- lm(hischshr1520f ~ di + xi + I(xi*di) +
                      partycount + lpop1994 +
                      ageshr19 + ageshr60 + sexr + shhs +
                      merkezi + merkezp + subbuyuk + buyuk +
                      factor(prov_num),
                    data = turquia)

# Hombres
modelo_m2 <- lm(hischshr1520m ~ di + xi + I(xi*di) +
                      partycount + lpop1994 +
                      ageshr19 + ageshr60 + sexr + shhs +
                      merkezi + merkezp + subbuyuk + buyuk +
                      factor(prov_num),
                    data = turquia)

# Errores clusterizados
se_f_2 <- sqrt(diag(vcovCL(modelo_f2, cluster = ~prov_num)))
se_m_2 <- sqrt(diag(vcovCL(modelo_m2, cluster = ~prov_num)))


# Tabla en Latex para Pdf
tabla2 <- capture.output(
  stargazer(modelo_f2, modelo_m2, se = list(se_f_2, se_m_2),
            type = "latex",
            dep.var.labels = c("Escolarización femenina", "Escolarización masculina"),
            column.labels = c("Mujeres", "Hombres"),
            covariate.labels = c(
              "Cobertura Globo (i98)",
              "X",
              "X_m",
              "Islam 1994",
              "Número de partidos",
              "Población 1994",
              "Edad 19",
              "Edad 60",
              "Sexo",
              "Shhs",
              "Merkezi",
              "Merkezp",
              "Subbuyuk",
              "Buyuk"
            ),
            title = "Impacto de Globo sobre escolarización por género",
            label = "tab:globo_genero",
            digits = 3,
            notes = "Errores estándar agrupados por provincia.")
)

# Quitar comentarios de stargazer (para un .tex limpio)
tabla2 <- tabla2[!grepl("^%", tabla2)]

# --- Guardar .tex limpio ---
writeLines(tabla2, "Tablas/tabla1.tex")

# Mostrar tabla en consola (opcional)
cat(tabla2, sep = "\n")

```

c.  Ecuación principal, para la submuestra a h unidades alrededor del corte, con controles.

```{r}
# Filtrar submuestra
turquia_sub <- subset(turquia, xi >= -0.24 & xi <= 0.24)

# Mujeres
modelo_f3 <- lm(hischshr1520f ~ di + xi + I(xi*di) +
                   partycount + lpop1994 +
                   ageshr19 + ageshr60 + sexr + shhs +
                   merkezi + merkezp + subbuyuk + buyuk +
                   factor(prov_num),
                 data = turquia_sub)

# Hombres
modelo_m3 <- lm(hischshr1520m ~ di + xi + I(xi*di) +
                   partycount + lpop1994 +
                   ageshr19 + ageshr60 + sexr + shhs +
                   merkezi + merkezp + subbuyuk + buyuk +
                   factor(prov_num),
                 data = turquia_sub)

# Errores clusterizados
se_f3 <- sqrt(diag(vcovCL(modelo_f3, cluster = ~prov_num)))
se_m3 <- sqrt(diag(vcovCL(modelo_m3, cluster = ~prov_num)))


```

d.  Ecuación principal, para la submuestra a h/2 unidades alrededor del corte, con controles

```{r}
# Filtrar la submuestra dentro del rango -0.12 a 0.12
turquia_sub_h2 <- subset(turquia, xi >= -0.12 & xi <= 0.12)

# Mujeres
modelo_f4 <- lm(hischshr1520f ~ di + xi + I(xi*di) +
                    partycount + lpop1994 +
                    ageshr19 + ageshr60 + sexr + shhs +
                    merkezi + merkezp + subbuyuk + buyuk +
                    factor(prov_num),
                  data = turquia_sub_h2)

# Hombres
modelo_m4 <- lm(hischshr1520m ~ di + xi + I(xi*di) +
                    partycount + lpop1994 +
                    ageshr19 + ageshr60 + sexr + shhs +
                    merkezi + merkezp + subbuyuk + buyuk +
                    factor(prov_num),
                  data = turquia_sub_h2)

# Errores clusterizados
se_f4 <- sqrt(diag(vcovCL(modelo_f4, cluster = ~prov_num)))
se_m4 <- sqrt(diag(vcovCL(modelo_m4, cluster = ~prov_num)))
```

donde h=0.24 es el ancho de banda óptimo estimado por los autores. Para las especificaciones con controles, supongan que:

$$f(x_i )= γx _i+δx_i×m_i$$

Es decir, un polinomio de grado uno con pendiente distinta a cada lado del corte. Para las especificaciones sin controles, no incluyan ningún polinomio. Todas las especificaciones deben usar errores estándar clúster a nivel de provincia.

```{r}
library(stargazer)

stargazer(modelo_f4, modelo_f4, modelo_f4, modelo_f4,
          se = list(se_f_noctrl, se_f_ctrl, se_f_h, se_f_h2),
          type = "text",
          dep.var.labels = "Escolarización femenina",
          column.labels = c("Sin controles", "Controles", "Controles h_hat", "Controles h_hat/2"),
          covariate.labels = c("Alcalde islámico", "xi", "xi*di",
                               "Número de partidos", "Población 1994", 
                               "Edad 19", "Edad 60", "Sexo", "Shhs",
                               "Merkezi", "Merkezp", "Subbuyuk", "Buyuk"),
          digits = 3,
          title = "Resultados por género: Mujeres")

```



## 3) A partir de los resultados encontrados en el anterior punto, respondan:

a.  ¿Por qué cambian los coeficientes entre especificaciones?
b.  ¿Cuál parece ser el impacto de la llegada al poder del Partido Islámico para las mujeres? ¿Parece ser este impacto robusto a las especificaciones?

Cami

## 4) Finalmente, presenten evidencia a favor (o en contra) del supuesto de identificación. Para esto,

a.  Presenten en una gráfica la distribución kernel o el histograma de la variable de asignación x_i. ¿Parece haber manipulación?

```{r}1
# Crear el gráfico de densidad (curva kernel)
grafico_kernel <- ggplot(turquia, aes(x = X)) +
  geom_density(fill = "blue", alpha = 0.5) +       # Curva kernel
  geom_vline(xintercept = 0, color = "red", linetype = "dashed", linewidth = 1) +
  labs(
    title = "Distribución de la variable de asignación (X) - Kernel",
    x = "Variable de asignación (X)",
    y = "Densidad"
  ) +
  theme_minimal()

# Mostrar en consola
grafico_kernel

# Guardar el gráfico
ggsave("Tablas/curva_kernel_X.png", plot = grafico_kernel, width = 8, height = 5, dpi = 300)

```

b.  En una tabla presenten los resultados de estimar la ecuación de interés, sin controles, pero incluyendo f(x_i), tomando como variables dependientes: i) la elección de un alcalde del partido Islámico en 1984 (i89) y ii) el logaritmo de la población en 1994 (lpop1994). Para esto, usen únicamente la muestra de elecciones alrededor del ancho de banda óptimo. Dados sus resultados, ¿parece haber continuidad en estas variables?

```{r}
# Modelo para i89
modelo_i89 <- feols(
  i89 ~ i98 + X + I(X^2) + factor(prov_num),
  data = turquia,
  cluster = ~prov_num
)

# Modelo para lpop1994
modelo_lpop <- feols(
  lpop1994 ~ i98 + X + I(X^2) + factor(prov_num),
  data = turquia,
  cluster = ~prov_num
)

# Tabla de resultados
etable(
  modelo_i89, modelo_lpop,
  se = "cluster",
  cluster = ~prov_num,
  tex = TRUE,  # TRUE para LaTeX, FALSE para consola
  file = "Tablas/continuidad_rd.tex",
  title = "Regresión Discontinua: Prueba de continuidad sin controles",
  dict = c(
    i89 = "Elección de alcalde islámico 1984",
    lpop1994 = "Log Población 1994",
    i98 = "Cobertura Globo (i98)",
    X = "X",
    "I(X^2)" = "X al cuadrado"
  ),
  keep = c("i98", "X", "I(X^2)")
)

```

c.  Dados sus resultados en los incisos a y b, ¿es plausible el supuesto de identificación? Expliquen por qué. Cami
