---
title: "Taller 5 - Regresión Discontinua"
author: "Maria Camila Caraballo, Laura Sarif Rivera Sanabria"
output:
  pdf_document:
    latex_engine: xelatex
  word_document: default
geometry: top=1.5cm, bottom=1.5cm, left=2cm, right=2cm
output_dir: outputs
header-includes: \usepackage{adjustbox}
---

```{r setup, include= FALSE, echo=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
knitr::opts_knit$set(root.dir = "C:/1. MECA/2025/EVALUACIACÓN DE IMPACTO- Raachid Raaj/Taller5-RegresionDiscontinua")

tinytex::tlmgr_update(self = TRUE, all = TRUE)

if (!requireNamespace("tinytex", quietly = TRUE)) {
  install.packages("tinytex")
}

# Verificar si TinyTeX está instalado
if (tinytex::is_tinytex()) {
  message("TinyTeX detectado. Actualizando instalación...")

  # Actualizar gestor de paquetes (self) y todos los paquetes
  tinytex::tlmgr_update(self = TRUE, all = TRUE)

  message("TinyTeX actualizado correctamente.")
} else {
  message("No se detecta TinyTeX. Si usas MikTeX o TeX Live, actualiza manualmente.")
}
```

```{r results='asis', echo=FALSE}
# Cargar liberias y paquetes
# Instalando pacman si se requiere
if (!require("pacman")) install.packages("pacman")

# Cargando los paquetes usando pacman
pacman::p_load(
  
  # A) Manipulación, limpieza y visualización de datos
  tidyverse,    # Colección de paquetes esenciales (incluye dplyr, ggplot2, etc.)
  dplyr,        # Manipulación de datos (ya incluido en tidyverse, pero lo dejamos explícito).
  ggplot2,      # Visualización de datos (incluido en tidyverse).
  scales,       # Manejo de escalas (ej. porcentajes, comas).
  skimr,        # Resúmenes estadísticos rápidos de data.frames.
  
  # B) Modelado y análisis estadístico/econométrico
  fixest,       # Modelos de efectos fijos de alto rendimiento.
  plm,          # Modelos para datos de panel.
  AER,          # Herramientas de econometría aplicada.
  lmtest,       # Pruebas de hipótesis para modelos de regresión.
  sandwich,     # Errores estándar robustos.
  survey,       # Análisis de encuestas complejas.
  
  # C) Importación, exportación y generación de reportes
  haven,        # Lectura/escritura de Stata, SAS, SPSS.
  stargazer,    # Tablas de regresión con formato publicable.
  knitr,        # Reportes dinámicos en RMarkdown.
  modelsummary, # Tablas y resúmenes comparativos de modelos.
  tinytex       # Soporte para compilar a PDF con LaTeX en RMarkdown.
)

library(lfe)
install.packages('rdrobust')
library(rdrobust)
```

## Regresión Discontinua

En su artículo “Islamic Rule and the Empowerment of the Poor and Pious”, Meyersson (2014) investiga si la llegada al poder por parte del Partido Islámico tiene algún efecto sobre el empoderamiento de las mujeres en Turquía. Para esto, implementa la metodología de Regresión Discontinua, explotando información de: (1) elecciones locales de alcalde en Turquía del año 1994 y (2) mujeres con educación secundaria completa en el año 2000. Concretamente, estima por MCO la siguiente ecuación

$$y_i=α+βm_i+f(x_i )+ε_i$$

donde $Y_i$ es la proporción de mujeres entre 15 y 20 años con educación secundaria completa en el año 2000, $x_i$ es el margen de votos con el que ganó o perdió el candidato del partido islámico, $f(.)$ es un polinomio de grado n de la variable $x_i$, $m_i$ es una dicótoma que toma el valor de uno si $x_i > 0$, es decir, si el alcalde que llegó al poder en 1994 era del partido Islámico y $\epsilon_i$ es el término del error. La ecuación es estimada en un vecindario alrededor del corte, el cual, en este caso, es cero.

### Preparación de los datos

Para esto se deberá eliminar aleatoriamente el 5% de las observaciones y usar la base restante. La semilla que deben usar para que sus resultados sean replicables es su código de estudiante.

```{r}
# Definir carpeta de datos (ruta relativa) 
path <- file.path(getwd(), "Datos/turquia.dta")
data <- read_dta(path)

# Fijar semilla con el cod de Laura
set.seed(202421904)

# Eliminar aletoriamente el 5% de las observaciones 
n_eliminar <- round(0.05 * nrow(data))
filas_eliminar <- sample(1:nrow(data), n_eliminar)
turquia <- data[-filas_eliminar, ]
```

```{r}
# Tratamiento de si se eligió un alcalde islámico
turquia <- turquia %>%
  rename(xi = ilmvsm1994) %>%       
  mutate(
    di = ifelse(xi >= 0, 1, 0),    # tratamiento: alcalde islámico
    hischshr1520m = hischshr1520m / 100,  
    hischshr1520f = hischshr1520f / 100
  )

```

### 1. Análisis introductorio

**¿Por qué el autor usa la metodología de Regresión Discontinua para identificar los efectos de interés? ¿Cuál es la intuición detrás? ¿Cuál es el supuesto de identificación?**

Erik Meyersson (2014) en su paper Islamic Rule And The Empowerment of the Poor and Pious busca identificar un efecto causal de las elecciones de partidos islámicos de los municipios en Turquia sobre los resultados de empoderamiento de las mujeres medido como la proporción de jóvenes entre 15 y 20 años con educación secundaria completa. Para ello utiliza la metodología de Regresión Discontinua (RD) aprovechando que la asignación del tratamiento, es decir, si es un alcalde islámico no es aleatoria, dado que los municipios que eligen a este tipo de líderes pueden diferir en factores culturales, religiosos o socioeconómicos, una simple comparación entre municipios con y sin alcalde islámico generaría estimaciones sesgadas.La estrategia de RD permite aproximarse a un experimento natural. La intuición es que los municipios donde el candidato islámico ganó o perdió por un margen pequeño puede ser comparable en todas sus características observables y no observables, de modo que el hecho de haber obtenido la alcaldía o no puede considerarse casi aleatorio.

El supuesto de identificación implica que, en ausencia del tratamiento, es decir, de haber tenido un alcalde del partido islámico, los resultados potenciales, como la proporción de mujeres jóvenes con educación secundaria completa serían continuos en torno al punto de corte del margen electoral. Esto implica que los municipios donde el candidato islámico ganó o perdió por muy poco son, en promedio, comparables en todas las características relevantes que podrían afectar el empoderamiento femenino.

**Para cada género, presenten en una tabla los resultados de estimar las siguientes especificaciones**

a.  Ecuación principal, para toda la muestra, sin incluir controles

```{r results='asis'}

# Primer modelo sin controles para ambos sexos
modelo_f <- lm(hischshr1520f ~ di + xi, data = turquia)  # mujeres
modelo_m <- lm(hischshr1520m ~ di + xi, data = turquia)  # hombres

# Errores estándar agrupados por provincia
se_f <- sqrt(diag(vcovCL(modelo_f, cluster = ~ prov_num)))
se_m <- sqrt(diag(vcovCL(modelo_m, cluster = ~ prov_num)))

# Tabla en Latex para Pdf
tabla1 <- capture.output(
  stargazer(
    modelo_f, modelo_m,
    type = "text",
    se = list(se_f, se_m),
    title = "Regresión Discontinua: efecto de alcaldes islámicos sobre educación secundaria",
    column.labels = c("Mujeres", "Hombres"),
    dep.var.labels = "Proporción con secundaria completa (15–20 años)",
    covariate.labels = c("Alcalde islámico (Dᵢ)", "Running Variable(Xᵢ)"),
    notes = "Errores estándar agrupados por provincia.",
    digits = 3,
    label = "tab:rd_mujeres_hombres",
    header = FALSE,  
    table.placement = "ht!"
  )
)

# Quitar comentarios de stargazer (para un .tex limpio)
tabla1 <- tabla1[!grepl("^%", tabla1)]

# --- Guardar .tex limpio ---
writeLines(tabla1, "Tablas/tabla1.tex")
```

```{r}
## Pruebita de metodos 
rd_f <-  rdrobust(y = turquia$hischshr1520f,
          x = turquia$xi,
          cluster = turquia$prov_num,
          c=0)

rd_m <- rdrobust(y = turquia$hischshr1520m,
          x = turquia$xi,
          cluster = turquia$prov_num,
          c=0)

grafico_m <- rdplot(y = turquia$hischshr1520m, x = turquia$xi,c=0)
grafico_f <- rdplot(y = turquia$hischshr1520f, x = turquia$xi,c=0)

# Crear tabla comparativa
tabla_resultados <- data.frame(
  Grupo = c("Mujeres", "Hombres"),
  Efecto_Estimado = round(c(rd_f$Estimate[1], rd_m$Estimate[1]), 4),
  Error_Estandar = round(c(rd_f$se[1], rd_m$se[1]), 4),
  Valor_p = round(c(rd_f$pv[1], rd_m$pv[1]), 4)
)

# Mostrar tabla
tabla_resultados

```

b.  Ecuación principal, para toda la muestra, con controles.

```{r results='asis'}
# Con controles y polinomio lineal 
# Mujeres
modelo_f2 <- lm(hischshr1520f ~ di + xi + I(xi*di) +
                      partycount + lpop1994 +
                      ageshr19 + ageshr60 + sexr + shhs +
                      merkezi + merkezp + subbuyuk + buyuk +
                      factor(prov_num),
                    data = turquia)

# Hombres
modelo_m2 <- lm(hischshr1520m ~ di + xi + I(xi*di) +
                      partycount + lpop1994 +
                      ageshr19 + ageshr60 + sexr + shhs +
                      merkezi + merkezp + subbuyuk + buyuk +
                      factor(prov_num),
                    data = turquia)

# Errores clusterizados
se_f_2 <- sqrt(diag(vcovCL(modelo_f2, cluster = ~prov_num)))
se_m_2 <- sqrt(diag(vcovCL(modelo_m2, cluster = ~prov_num)))


# Tabla en Latex para Pdf
tabla2 <- capture.output(
  stargazer(
    modelo_f2, modelo_m2,
    type = "latex",
    se = list(se_f_2, se_m_2),
    title = "Regresión Discontinua con Controles: efecto de alcaldes islámicos sobre educación secundaria",
    column.labels = c("Mujeres", "Hombres"),
    dep.var.labels = "Proporción con secundaria completa (15–20 años)",
    covariate.labels = c(
      "Alcalde islámico (Dᵢ)",
      "Running Variable (Xᵢ)",
      "Interacción Dᵢ·Xᵢ",
      "Número de partidos (1994)",
      "Población (log, 1994)",
      "Proporción 0–19 años",
      "Proporción 60+ años",
      "Razón de sexo",
      "Tamaño promedio del hogar",
      "Categoría: Merkezi",
      "Categoría: Merkezp",
      "Categoría: Sub-Büyük",
      "Categoría: Büyük",
      "Efectos fijos por provincia"
    ),
    notes = "Errores estándar agrupados por provincia. Todos los modelos incluyen efectos fijos por provincia.",
    digits = 3,
    label = "tab:rd_controles_mujeres_hombres",
    header = FALSE,
    table.placement = "ht!"
  )
)

# Quitar comentarios de stargazer (para un .tex limpio)
tabla2 <- tabla2[!grepl("^%", tabla2)]

# --- Guardar .tex limpio ---
writeLines(tabla2, "Tablas/tabla2.tex")

# Mostrar tabla en consola (opcional)
cat(tabla2, sep = "\n")

```

c.  Ecuación principal, para la submuestra a h unidades alrededor del corte, con controles.

```{r results='asis'}
# Filtrar submuestra
turquia_sub <- subset(turquia, xi >= -0.24 & xi <= 0.24)

# Mujeres
modelo_f3 <- lm(hischshr1520f ~ di + xi + I(xi*di) +
                   partycount + lpop1994 +
                   ageshr19 + ageshr60 + sexr + shhs +
                   merkezi + merkezp + subbuyuk + buyuk +
                   factor(prov_num),
                 data = turquia_sub)

# Hombres
modelo_m3 <- lm(hischshr1520m ~ di + xi + I(xi*di) +
                   partycount + lpop1994 +
                   ageshr19 + ageshr60 + sexr + shhs +
                   merkezi + merkezp + subbuyuk + buyuk +
                   factor(prov_num),
                 data = turquia_sub)

# Errores clusterizados
se_f3 <- sqrt(diag(vcovCL(modelo_f3, cluster = ~prov_num)))
se_m3 <- sqrt(diag(vcovCL(modelo_m3, cluster = ~prov_num)))

# Tabla en LaTeX
tabla3 <- capture.output(
  stargazer(
    modelo_f3, modelo_m3,
    type = "latex",
    se = list(se_f3, se_m3),
    title = "Regresión Discontinua con Controles (submuestra ±ĥ alrededor del corte)",
    column.labels = c("Mujeres", "Hombres"),
    dep.var.labels = "Proporción con secundaria completa (15–20 años)",
    covariate.labels = c(
      "Alcalde islámico (Dᵢ)",
      "Running Variable (Xᵢ)",
      "Interacción Dᵢ·Xᵢ",
      "Número de partidos (1994)",
      "Población (log, 1994)",
      "Proporción 0–19 años",
      "Proporción 60+ años",
      "Razón de sexo",
      "Tamaño promedio del hogar",
      "Categoría: Merkezi",
      "Categoría: Merkezp",
      "Categoría: Sub-Büyük",
      "Categoría: Büyük",
      "Efectos fijos por provincia"
    ),
    notes = "Errores estándar agrupados por provincia. Submuestra: ±ĥ unidades alrededor del punto de corte. Incluye controles y efectos fijos por provincia.",
    digits = 3,
    label = "tab:rd_submuestra_h_mujeres_hombres",
    header = FALSE,
    table.placement = "ht!"
  )
)

# Quitar comentarios de stargazer (para un .tex limpio)
tabla3 <- tabla3[!grepl("^%", tabla3)]

# --- Guardar .tex limpio ---
writeLines(tabla3, "Tablas/tabla3.tex")

# Mostrar tabla en consola (opcional)
cat(tabla3, sep = "\n")


```

d.  Ecuación principal, para la submuestra a h/2 unidades alrededor del corte, con controles

```{r results='asis'}
# Filtrar la submuestra dentro del rango -0.12 a 0.12
turquia_sub_h2 <- subset(turquia, xi >= -0.12 & xi <= 0.12)

# Mujeres
modelo_f4 <- lm(hischshr1520f ~ di + xi + I(xi*di) +
                    partycount + lpop1994 +
                    ageshr19 + ageshr60 + sexr + shhs +
                    merkezi + merkezp + subbuyuk + buyuk +
                    factor(prov_num),
                  data = turquia_sub_h2)

# Hombres
modelo_m4 <- lm(hischshr1520m ~ di + xi + I(xi*di) +
                    partycount + lpop1994 +
                    ageshr19 + ageshr60 + sexr + shhs +
                    merkezi + merkezp + subbuyuk + buyuk +
                    factor(prov_num),
                  data = turquia_sub_h2)

# Errores clusterizados
se_f4 <- sqrt(diag(vcovCL(modelo_f4, cluster = ~prov_num)))
se_m4 <- sqrt(diag(vcovCL(modelo_m4, cluster = ~prov_num)))

# Tabla en LaTeX
tabla4 <- capture.output(
  stargazer(
    modelo_f4, modelo_m4,
    type = "latex",
    se = list(se_f4, se_m4),
    title = "Regresión Discontinua con Controles (submuestra ±ĥ/2 alrededor del corte)",
    column.labels = c("Mujeres", "Hombres"),
    dep.var.labels = "Proporción con secundaria completa (15–20 años)",
    covariate.labels = c(
      "Alcalde islámico (Dᵢ)",
      "Running Variable (Xᵢ)",
      "Interacción Dᵢ·Xᵢ",
      "Número de partidos (1994)",
      "Población (log, 1994)",
      "Proporción 0–19 años",
      "Proporción 60+ años",
      "Razón de sexo",
      "Tamaño promedio del hogar",
      "Categoría: Merkezi",
      "Categoría: Merkezp",
      "Categoría: Sub-Büyük",
      "Categoría: Büyük",
      "Efectos fijos por provincia"
    ),
    notes = "Errores estándar agrupados por provincia. Submuestra: ±ĥ/2 unidades alrededor del punto de corte. Incluye controles y efectos fijos por provincia.",
    digits = 3,
    label = "tab:rd_submuestra_h2_mujeres_hombres",
    header = FALSE,
    table.placement = "ht!"
  )
)


# Quitar comentarios de stargazer (para un .tex limpio)
tabla4 <- tabla4[!grepl("^%", tabla4)]

# --- Guardar .tex limpio ---
writeLines(tabla4, "Tablas/tabla4.tex")

# Mostrar tabla en consola (opcional)
cat(tabla4, sep = "\n")

```

donde h=0.24 es el ancho de banda óptimo estimado por los autores. Para las especificaciones con controles, supongan que:

$$f(x_i )= γx _i+δx_i×m_i$$

Es decir, un polinomio de grado uno con pendiente distinta a cada lado del corte. Para las especificaciones sin controles, no incluyan ningún polinomio. Todas las especificaciones deben usar errores estándar clúster a nivel de provincia.

## 3) A partir de los resultados encontrados en el anterior punto, respondan:

a.  ¿Por qué cambian los coeficientes entre especificaciones?

Los coeficientes cambian entre los modelos porque al incluir controles adicionales se corrige por diferencias observables entre municipios, reduciendo potenciales sesgos de omisión y permitiendo que la estimación del efecto de tener un alcalde islámico sea más precisa y cercana al efecto causal.Además, al reducir el ancho de banda y enfocarse en municipios más cercanos al umbral, las estimaciones se vuelven más comparables, aunque aumentan los errores estándar por el menor número de observaciones.

El coeficiente para mujeres es negativo y significativo, mientras que con controles cambia a positivo y significativo, lo que sugiere que la estimación inicial estaba sesgada por diferencias preexistentes entre municipios. Para los hombres, el coeficiente con controles es cercano a cero y no significativo, pero aumenta sin controles, aunque sigue sin ser significativo.

b.  ¿Cuál parece ser el impacto de la llegada al poder del Partido Islámico para las mujeres? ¿Parece ser este impacto robusto a las especificaciones?

n la estimación sin controles, el coeficiente es negativo y significativo, lo que sugiere inicialmente que la llegada de un alcalde islámico podría reducir la proporción de mujeres con educación secundaria. Sin embargo, al incluir controles, el efecto cambia de signo y se vuelve positivo, lo que indica que la estimación inicial estaba sesgada por características preexistentes de los municipios. En conjunto, la evidencia sugiere que, tras ajustar por esos sesgos, los municipios gobernados por alcaldes islámicos presentan una mayor educación para las mujeres.

## 4) Finalmente, presenten evidencia a favor (o en contra) del supuesto de identificación. Para esto,

a.  Presenten en una gráfica la distribución kernel o el histograma de la variable de asignación x_i. ¿Parece haber manipulación?

El gráfico 1 muestra la densidad kernel del margen de votos del partido islámico en 1994 (xi) y evidencia el supuesto de identificación de la metodología RD debido a que en ausencia del tratameinto que es tener un alcalde islamico, los resultados potenciales sobre la educación secundaria en las mujeres, habría sido continua en torno al umbral. Por lo tanto, sugiere que no hubo manipulación electoral en los municipios donde el partido islámico gano o perio entonces las características son comparables.

```{r results='asis'}
# Gráfico de densidad kernel de xi
grafico_kernel <- ggplot(turquia, aes(x = xi)) +
  geom_density(fill = "lightblue", alpha = 0.5, color = "steelblue", linewidth = 1) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "red", linewidth = 0.8) +
  labs(
    title = "Densidad kernel del margen electoral (xi)",
    x = "Running Variable (xi)",
    y = "Densidad"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    panel.grid.minor = element_blank()
  )

# Mostrar 
print(grafico_kernel)

# Guardar 
ggsave(
  filename = "Tablas/grafico_kernel.png",
  plot = grafico_kernel,
  width = 7, height = 5, dpi = 300
)

```

b.  En una tabla presenten los resultados de estimar la ecuación de interés, sin controles, pero incluyendo f(x_i), tomando como variables dependientes: i) la elección de un alcalde del partido Islámico en 1984 (i89) y ii) el logaritmo de la población en 1994 (lpop1994). Para esto, usen únicamente la muestra de elecciones alrededor del ancho de banda óptimo. Dados sus resultados, ¿parece haber continuidad en estas variables?

```{r results='asis'}
# Alcalde islámico en 1984
modelo_i89 <- lm(i89 ~ di + xi + I(xi*di), data = turquia_sub)

# Log población en 1994
modelo_lpop <- lm(lpop1994 ~ di + xi + I(xi*di), data = turquia_sub)

# Errores clusterizados
se_i89 <- sqrt(diag(vcovCL(modelo_i89, cluster = ~prov_num)))
se_lpop <- sqrt(diag(vcovCL(modelo_lpop, cluster = ~prov_num)))

# Tabla
stargazer(modelo_i89, modelo_lpop,
          se = list(se_i89, se_lpop),
          type = "latex",
          dep.var.labels = c("Alcalde islámico en 1984", "Log población 1994"),
          covariate.labels = c("Ganó alcalde islámico", "Margen electoral", "Interacción margen x ganador"),
          title = "Prueba de continuidad en variables predeterminadas",
          label = "tab:continuidad_predeterminadas",
          out = "Tablas/tabla5.tex")
```

c.  Dados sus resultados en los incisos a y b, ¿es plausible el supuesto de identificación? Expliquen por qué.

Los resultados obtenidos respaldan la validez del supuesto de identificación en el diseño de regresión discontinua. La evidencia sugiere que no existe manipulación de la variable running, ya que la distribución de la variable alrededor del umbral se mantiene continua y sin saltos evidentes, de acuerdo con el gráfico de densidad. Asi mismo, la elección de un alcalde del partido Islámico en 1984 y el logaritmo de la población en 1994 no son significativos.
