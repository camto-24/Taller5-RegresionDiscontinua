---
title: "Taller 5 - Regresión Discontinua"
author: "Maria Camila Caraballo, Laura Sarif Rivera"
output:
  pdf_document:
    latex_engine: xelatex
  word_document: default
geometry: top=1.5cm, bottom=1.5cm, left=2cm, right=2cm
output_dir: outputs
header-includes: \usepackage{adjustbox}
---

```{r setup, include= FALSE, echo=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
knitr::opts_knit$set(root.dir = "C:/Users/mc-c2/OneDrive - Universidad de los andes/Universidad/MECA/Big Data y Machine Learning/Repositorios/BD_ML_taller_1/Taller5-RegresionDiscontinua")

tinytex::tlmgr_update(self = TRUE, all = TRUE)

if (!requireNamespace("tinytex", quietly = TRUE)) {
  install.packages("tinytex")
}

# Verificar si TinyTeX está instalado
if (tinytex::is_tinytex()) {
  message("TinyTeX detectado. Actualizando instalación...")

  # Actualizar gestor de paquetes (self) y todos los paquetes
  tinytex::tlmgr_update(self = TRUE, all = TRUE)

  message("TinyTeX actualizado correctamente.")
} else {
  message("No se detecta TinyTeX. Si usas MikTeX o TeX Live, actualiza manualmente.")
}
```

```{r results='asis', echo=FALSE}
# Cargar liberias y paquetes
# Instalando pacman si se requiere
if (!require("pacman")) install.packages("pacman")

# Cargando los paquetes usando pacman
pacman::p_load(
  
  # A) Manipulación, limpieza y visualización de datos
  tidyverse,    # Colección de paquetes esenciales (incluye dplyr, ggplot2, etc.)
  dplyr,        # Manipulación de datos (ya incluido en tidyverse, pero lo dejamos explícito).
  ggplot2,      # Visualización de datos (incluido en tidyverse).
  scales,       # Manejo de escalas (ej. porcentajes, comas).
  skimr,        # Resúmenes estadísticos rápidos de data.frames.
  
  # B) Modelado y análisis estadístico/econométrico
  fixest,       # Modelos de efectos fijos de alto rendimiento.
  plm,          # Modelos para datos de panel.
  AER,          # Herramientas de econometría aplicada.
  lmtest,       # Pruebas de hipótesis para modelos de regresión.
  sandwich,     # Errores estándar robustos.
  survey,       # Análisis de encuestas complejas.
  
  # C) Importación, exportación y generación de reportes
  haven,        # Lectura/escritura de Stata, SAS, SPSS.
  stargazer,    # Tablas de regresión con formato publicable.
  knitr,        # Reportes dinámicos en RMarkdown.
  modelsummary, # Tablas y resúmenes comparativos de modelos.
  tinytex       # Soporte para compilar a PDF con LaTeX en RMarkdown.
)

```

## Taller Regresión Discontinua

En su artículo “Islamic Rule and the Empowerment of the Poor and Pious”, Meyersson (2014) investiga si la llegada al poder por parte del Partido Islámico tiene algún efecto sobre el empoderamiento de las mujeres en Turquía. Para esto, implementa la metodología de Regresión Discontinua, explotando información de: (1) elecciones locales de alcalde en Turquía del año 1994 y (2) mujeres con educación secundaria completa en el año 2000. Concretamente, estima por MCO la siguiente ecuación

$$y_i=α+βm_i+f(x_i )+ε_i$$

donde $Y_i$ es la proporción de mujeres entre 15 y 20 años con educación secundaria completa en el año 2000, $x_i$ es el margen de votos con el que ganó o perdió el candidato del partido islámico, $f(.)$ es un polinomio de grado n de la variable $x_i$, $m_i$ es una dicótoma que toma el valor de uno si $x_i > 0$, es decir, si el alcalde que llegó al poder en 1994 era del partido Islámico y $\epsilon_i$ es el término del error. La ecuación es estimada en un vecindario alrededor del corte, el cual, en este caso, es cero.

### Preparación de los datos

Para esto se deberá eliminar aleatoriamente el 5% de las observaciones y usar la base restante. La semilla que deben usar para que sus resultados sean replicables es su código de estudiante.

```{r}
# Definir carpeta de datos (ruta relativa) 
path <- file.path(getwd(), "Datos/turquia.dta")
data <- read_dta(path)

# Fijar semilla con el cod de Laura
set.seed(202421904)

# Eliminar aletoriamente el 5% de las observaciones 
n_eliminar <- round(0.05 * nrow(data))
filas_eliminar <- sample(1:nrow(data), n_eliminar)
turquia <- data[-filas_eliminar, ]
```

```{r}
# Tratamiento de si se eligió un alcalde islámico
turquia <- turquia %>%
  rename(xi = ilmvsm1994) %>%       
  mutate(
    di = ifelse(xi >= 0, 1, 0),    # tratamiento: alcalde islámico
    hischshr1520m = hischshr1520m / 100,  
    hischshr1520f = hischshr1520f / 100
  )

```

### 1. Análisis introductorio

**¿Por qué el autor usa la metodología de Regresión Discontinua para identificar los efectos de interés? ¿Cuál es la intuición detrás? ¿Cuál es el supuesto de identificación?**

Erik Meyersson (2014) en su trabajo *Islamic Rule and the Empowerment of the Poor and Pious* busca identificar el efecto causal de que un municipio sea gobernado por un alcalde islámico sobre el empoderamiento de las mujeres, medido a través de la proporción de jóvenes entre 15 y 20 años con educación secundaria completa. El desafío metodológico radica en que la elección de un partido islámico no es aleatoria, ya que los municipios que votan por estos partidos pueden diferir en características culturales, religiosas o socioeconómicas que también influyen en los resultados educativos. Si se compararan directamente municipios con y sin alcalde islámico, las estimaciones resultarían sesgadas por esas diferencias estructurales.

La metodología de regresión discontinua ofrece una solución porque permite aislar la variación que puede considerarse casi aleatoria en torno al umbral de victoria electoral. Cuando un candidato gana o pierde por un margen muy pequeño, el resultado depende más del azar o de factores impredecibles que de diferencias estructurales entre los municipios. En ese punto de corte, ganar o perder una elección es casi como producto del azar, lo que genera un entorno cuasi experimental en el que las unidades a ambos lados del umbral son muy parecidas. Conceptualmente, los municipios que se ubican justo por encima o por debajo del margen de victoria del partido islámico tienen el mismo perfil social, económico y cultural, por lo que cualquier salto en los resultados educativos observado exactamente en el punto de corte puede interpretarse como consecuencia directa de haber tenido un alcalde islámico.

El supuesto fundamental de identificación es el de continuidad, consiste en que en ausencia del tratamiento el resultado esperado variaría de manera continua con el margen de victoria electoral. Esto implica que no existen saltos sistemáticos en el resultado alrededor del punto de corte que no estén causados por la victoria del partido islamista. Es decir, el supuesto sostiene que cerca del umbral los municipios son similares en todo aspecto salvo en la variable de tratamiento, lo que permite interpretar la discontinuidad observada en los resultados como un efecto causal del triunfo electoral del partido.

\newpage

### 2. Para cada género, presenten en una tabla los resultados de estimar las siguientes especificacione

**a. Ecuación principal, para toda la muestra, sin incluir controles**

```{r results='asis'}

# Primer modelo sin controles para ambos sexos
modelo_f <- lm(hischshr1520f ~ di*xi, data = turquia)  # mujeres
modelo_m <- lm(hischshr1520m ~ di*xi, data = turquia)  # hombres

# Errores estándar agrupados por provincia
se_f <- sqrt(diag(vcovCL(modelo_f, cluster = ~ prov_num)))
se_m <- sqrt(diag(vcovCL(modelo_m, cluster = ~ prov_num)))

# Tabla en Latex para Pdf
tabla1 <- capture.output(
  stargazer(
    modelo_f, modelo_m,
    type = "latex",
    se = list(se_f, se_m),
    title = "Efecto de alcaldes islámicos sobre educación secundaria",
    column.labels = c("Mujeres", "Hombres"),
    dep.var.labels = "Proporción con secundaria completa (15–20 años)",
    dep.var.labels.include = FALSE, 
    covariate.labels = c(
      "Alcalde islámico (Dᵢ)"
    ),
    notes = "Errores estándar agrupados por provincia.",
    digits = 3,
    label = "tab:rd_mujeres_hombres",
    header = FALSE,
    table.placement = "ht!",
    escape = TRUE,
    single.row = TRUE
  )
)

# Quitar comentarios de stargazer (para un .tex limpio)
tabla1 <- tabla1[!grepl("^%", tabla1)]
print(tabla1)

# --- Guardar .tex limpio ---
writeLines(tabla1, "Tablas/tabla1.tex")
```

\newpage

**b. Ecuación principal, para toda la muestra, con controles.**

```{r results='asis'}
# Con controles y polinomio lineal 
# Mujeres
modelo_f2 <- lm(hischshr1520f ~ di + xi + I(xi*di) +
                      partycount + lpop1994 +
                      ageshr19 + ageshr60 + sexr + shhs +
                      merkezi + merkezp + subbuyuk + buyuk,
                      data = turquia)

# Hombres
modelo_m2 <- lm(hischshr1520m ~ di + xi + I(xi*di) +
                      partycount + lpop1994 +
                      ageshr19 + ageshr60 + sexr + shhs +
                      merkezi + merkezp + subbuyuk + buyuk,
                    data = turquia)

# Errores clusterizados
se_f_2 <- sqrt(diag(vcovCL(modelo_f2, cluster = ~prov_num)))
se_m_2 <- sqrt(diag(vcovCL(modelo_m2, cluster = ~prov_num)))


# Tabla en Latex para Pdf
tabla2 <- capture.output(
  stargazer(
    modelo_f2, modelo_m2,
    type = "latex",
    se = list(se_f_2, se_m_2),
    title = "Efecto de alcaldes islámicos sobre educación secundaria",
    column.labels = c("Mujeres", "Hombres"),
    dep.var.labels = "Proporción con secundaria completa (15–20 años)",
    dep.var.labels.include = FALSE,
    covariate.labels = c(
      "Alcalde islámico (Dᵢ)",
      "Número de partidos (1994)",
      "Población (log, 1994)",
      "Proporción 0–19 años",
      "Proporción 60+ años",
      "Razón de sexo",
      "Tamaño promedio del hogar",
      "Categoría: Merkezi",
      "Categoría: Merkezp",
      "Categoría: Sub-Büyük",
      "Categoría: Büyük"
    ),
    notes = "Errores estándar agrupados por provincia. Todos los modelos incluyen efectos fijos por provincia.",
    digits = 3,
    label = "tab:rd_controles_mujeres_hombres",
    header = FALSE,
    table.placement = "ht!",
    escape = TRUE,
    single.row = TRUE
  )
)

# Quitar comentarios de stargazer (para un .tex limpio)
tabla2 <- tabla2[!grepl("^%", tabla2)]
print(tabla2)

# --- Guardar .tex limpio ---
writeLines(tabla2, "Tablas/tabla2.tex")

# Mostrar tabla en consola (opcional)
cat(tabla2, sep = "\n")

```

\newpage

Donde h=0.24 es el ancho de banda óptimo estimado por los autores. Para las especificaciones con controles, supongan que:

$$f(x_i )= γx _i+δx_i×m_i$$

Es decir, un polinomio de grado uno con pendiente distinta a cada lado del corte. Para las especificaciones sin controles, no incluyan ningún polinomio. Todas las especificaciones deben usar errores estándar clúster a nivel de provincia.

**c. Ecuación principal, para la submuestra a h unidades alrededor del corte, con controles.**

```{r results='asis'}
# Filtrar submuestra
turquia_sub <- subset(turquia, xi >= -0.24 & xi <= 0.24)

# Mujeres
modelo_f3 <- lm(hischshr1520f ~ di + xi + I(xi*di) +
                   partycount + lpop1994 +
                   ageshr19 + ageshr60 + sexr + shhs +
                   merkezi + merkezp + subbuyuk + buyuk,
                 data = turquia_sub)

# Hombres
modelo_m3 <- lm(hischshr1520m ~ di + xi + I(xi*di) +
                   partycount + lpop1994 +
                   ageshr19 + ageshr60 + sexr + shhs +
                   merkezi + merkezp + subbuyuk + buyuk,
                 data = turquia_sub)

# Errores clusterizados
se_f3 <- sqrt(diag(vcovCL(modelo_f3, cluster = ~prov_num)))
se_m3 <- sqrt(diag(vcovCL(modelo_m3, cluster = ~prov_num)))

# Tabla en LaTeX
tabla3 <- capture.output(
  stargazer(
    modelo_f3, modelo_m3,
    type = "latex",
    se = list(se_f3, se_m3),
    title = "Regresión Discontinua con controles (submuestra ĥ alrededor del corte)",
    column.labels = c("Mujeres", "Hombres"),
    dep.var.labels = "Proporción con secundaria completa (15–20 años)",
    dep.var.labels.include = FALSE,
    covariate.labels = c(
      "Alcalde islámico (Dᵢ)",
      "Número de partidos (1994)",
      "Población (log, 1994)",
      "Proporción 0–19 años",
      "Proporción 60+ años",
      "Razón de sexo",
      "Tamaño promedio del hogar",
      "Categoría: Merkezi",
      "Categoría: Merkezp",
      "Categoría: Sub-Büyük",
      "Categoría: Büyük"
    ),
    notes = "Errores estándar agrupados por provincia. Submuestra: ±ĥ unidades alrededor del punto de corte. Incluye controles y efectos fijos por provincia.",
    digits = 3,
    label = "tab:rd_submuestra_h_mujeres_hombres",
    header = FALSE,
    table.placement = "ht!",
    escape = TRUE,
    single.row = TRUE
  )
)

# Quitar comentarios de stargazer (para un .tex limpio)
tabla3 <- tabla3[!grepl("^%", tabla3)]
print(tabla3)

# --- Guardar .tex limpio ---
writeLines(tabla3, "Tablas/tabla3.tex")

# Mostrar tabla en consola (opcional)
cat(tabla3, sep = "\n")

```

\newpage

**d. Ecuación principal, para la submuestra a h/2 unidades alrededor del corte, con controles**

```{r results='asis'}
# Filtrar la submuestra dentro del rango -0.12 a 0.12
turquia_sub_h2 <- subset(turquia, xi >= -0.12 & xi <= 0.12)

# Mujeres
modelo_f4 <- lm(hischshr1520f ~ di + xi + I(xi*di) +
                    partycount + lpop1994 +
                    ageshr19 + ageshr60 + sexr + shhs +
                    merkezi + merkezp + subbuyuk + buyuk,
                  data = turquia_sub_h2)

# Hombres
modelo_m4 <- lm(hischshr1520m ~ di + xi + I(xi*di) +
                    partycount + lpop1994 +
                    ageshr19 + ageshr60 + sexr + shhs +
                    merkezi + merkezp + subbuyuk + buyuk,
                  data = turquia_sub_h2)

# Errores clusterizados
se_f4 <- sqrt(diag(vcovCL(modelo_f4, cluster = ~prov_num)))
se_m4 <- sqrt(diag(vcovCL(modelo_m4, cluster = ~prov_num)))

# Tabla en LaTeX
tabla4 <- capture.output(
  stargazer(
    modelo_f4, modelo_m4,
    type = "latex",
    se = list(se_f4, se_m4),
    title = "Regresión Discontinua con controles y ±ĥ/)",
    column.labels = c("Mujeres", "Hombres"),
    dep.var.labels = "Proporción con secundaria completa (15–20 años)",
    dep.var.labels.include = FALSE,
    covariate.labels = c(
      "Alcalde islámico (Dᵢ)",
      "Número de partidos (1994)",
      "Población (log, 1994)",
      "Proporción 0–19 años",
      "Proporción 60+ años",
      "Razón de sexo",
      "Tamaño promedio del hogar",
      "Categoría: Merkezi",
      "Categoría: Merkezp",
      "Categoría: Sub-Büyük",
      "Categoría: Büyük"
    ),
    notes = "Errores estándar agrupados por provincia. Submuestra: ±ĥ/2 unidades alrededor del punto de corte. Incluye controles y efectos fijos por provincia.",
    digits = 3,
    label = "tab:rd_submuestra_h2_mujeres_hombres",
    header = FALSE,
    table.placement = "ht!",
    escape = TRUE,
    single.row = TRUE
  )
)

# Quitar comentarios de stargazer (para un .tex limpio)
tabla4 <- tabla4[!grepl("^%", tabla4)]
print(tabla4)

# --- Guardar .tex limpio ---
writeLines(tabla4, "Tablas/tabla4.tex")

```

\newpage

### 3. A partir de los resultados encontrados en el anterior punto, respondan:

**a. ¿Por qué cambian los coeficientes entre especificaciones?**

Los coeficientes cambian entre especificaciones porque cada modelo incorpora distintos supuestos y grados de control sobre posibles problemas de sesgo. En la primera estimación, que no incluye variables de control, el modelo capta únicamente la discontinuidad simple en torno al umbral de victoria electoral. Al introducir controles socioeconómicos y demográficos en las siguientes especificaciones, el modelo mejora la estimación del efecto del alcalde islámico de otras características municipales que también pueden influir en la educación. Asimismo, al restringir la muestra a bandas más estrechas alrededor del punto de corte, se reduce la heterogeneidad entre observaciones, lo que mejora la validez causal pero puede aumentar la varianza de la estimación. Por estas razones, los coeficientes cambian ligeramente entre especificaciones, reflejando cómo la inclusión de controles y la reducción del ancho de banda afectan la precisión y el sesgo potencial del estimador

**b. ¿Cuál parece ser el impacto de la llegada al poder del Partido Islámico para las mujeres? ¿Parece ser este impacto robusto a las especificaciones?**

En cuanto al efecto de la llegada al poder del partido islámico sobre la educación de las mujeres, los resultados muestran que este impacto es positivo y estadísticamente significativo en las especificaciones que integran controles y restringen la muestra alrededor del umbral. En particular, en los modelos de regresión discontinua con controles, tanto en la muestra con ancho de banda óptimo como en la reducida a la mitad, el coeficiente asociado a tener un alcalde islámico es positivo y significativo al 1% o 5%. Esto sugiere que la presencia de un gobierno municipal islámico se asocia con una mayor proporción de mujeres jóvenes que completan la educación secundaria.

Finalmente, el hecho de que los coeficientes se mantengan positivos y significativos para las mujeres en las distintas especificaciones indica que el resultado es robusto. A pesar de los cambios en la inclusión de controles o en el tamaño de la muestra, la dirección y magnitud del efecto son consistentes, mientras que para los hombres los coeficientes no son estadísticamente significativos en la mayoría de los casos. Esto refuerza la interpretación de que el impacto de los alcaldes islámicos es específico al grupo femenino y que los resultados no dependen de una especificación particular del modelo, sino que se sostienen bajo diferentes estrategias de estimación.

### 4. Finalmente, presenten evidencia a favor (o en contra) del supuesto de identificación, para esto:

**a. Presenten en una gráfica de la distribución kernel o el histograma de la variable de asignación**$x_i$ **¿Parece haber manipulación?**

```{r results='asis'}
# Gráfico de densidad kernel de xi
grafico_kernel <- ggplot(turquia, aes(x = xi)) +
  geom_density(fill = "lightblue", alpha = 0.5, color = "steelblue", linewidth = 1) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "red", linewidth = 0.8) +
  labs(
    title = "Densidad kernel del margen electoral (xi)",
    x = "Running Variable (xi)",
    y = "Densidad"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    panel.grid.minor = element_blank()
  )

# Mostrar 
print(grafico_kernel)

# Guardar 
ggsave(
  filename = "Tablas/grafico_kernel.png",
  plot = grafico_kernel,
  width = 7, height = 5, dpi = 300
)
```

El gráfico no indica la presencia de manipulación en el umbral de asignación. El supuesto de no manipulación en el diseño de regresión discontinua requiere que la densidad de observaciones en la variable de running sea continua en el punto de corte (que en este caso se marca en el punto 0). La densidad que se observa es suave y no presenta un quiebre, un salto o una caída abrupta en el umbral. Esta continuidad es una evidencia fundamental que sugiere que la probabilidad de ganar o perder por un margen pequeño es practicamente la misma, lo cual valida la asignación del tratamiento como cuasi-aleatoria.

\newpage

**b. En una tabla presenten los resultados de estimar la ecuación de interés, sin controles, pero incluyendo** $f(x_i)$ **tomando como variables dependientes: i) la elección de un alcalde del partido Islámico en 1984 (i89) y ii) el logaritmo de la población en 1994 (lpop1994). Para esto, usen únicamente la muestra de elecciones alrededor del ancho de banda óptimo. Dados sus resultados, ¿parece haber continuidad en estas variables?**

```{r results='asis'}
# Alcalde islámico en 1984
modelo_i89 <- lm(i89 ~ di + xi + I(xi*di), data = turquia_sub)

# Log población en 1994
modelo_lpop <- lm(lpop1994 ~ di + xi + I(xi*di), data = turquia_sub)

# Errores clusterizados
se_i89 <- sqrt(diag(vcovCL(modelo_i89, cluster = ~prov_num)))
se_lpop <- sqrt(diag(vcovCL(modelo_lpop, cluster = ~prov_num)))

# Tabla
tabla5 <- capture.output(
  stargazer(modelo_i89, modelo_lpop,
          se = list(se_i89, se_lpop),
          type = "latex",
          dep.var.labels = c("Alcalde islámico en 1984", "Log población 1994"),
          covariate.labels = c("Ganó alcalde islámico", "Margen electoral", "Interacción margen x ganador"),
    title = "Prueba de continuidad en variables específicas",
          label = "tab:continuidad_predeterminadas",
          header = FALSE,
          table.placement = "ht!",
          escape = TRUE,
          single.row = TRUE
  )
)

# Quitar comentarios de stargazer (para un .tex limpio)
tabla5 <- tabla5[!grepl("^%", tabla5)]

# --- Guardar .tex limpio ---
writeLines(tabla5, "Tablas/tabla5.tex")

# Mostrar tabla en consola
cat(tabla5, sep = "\n")

```

\newpage

**c. Dados sus resultados en los incisos a y b, ¿es plausible el supuesto de identificación? Expliquen por qué.**

Los resultados indican una continuidad en las covariables analizadas. Esta prueba permite confirmar que variables que no deberían ser afectadas por el resultado electoral de 1994 no muestran un salto significativo en el punto de corte. La continuidad se verifica al observar que el coeficiente estimado, que captura la discontinuidad en el punto de corte, es estadísticamente indistinguible de cero para las variables analizadas. Específicamente, el valor P amplio para el Alcalde Islámico en 1989 (0.781) y para el Logaritmo de la Población en 1994 (0.866) demuestra que no existe una diferencia significativa en el historial político o el tamaño poblacional entre los municipios que apenas ganaron y los que apenas perdieron la elección de 1994. Esta ausencia de un salto brusco en las covariables antes del tratamiento refuerza la credibilidad de que la asignación del tratamiento es aleatoria en el umbral, lo cual es el supuesto de identificación central del diseño de regresión discontinua.
